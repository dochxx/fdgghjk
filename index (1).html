<!doctype html><html><head><meta charset="utf-8"/><title>Bundled App</title><meta name="viewport" content="width=device-width,initial-scale=1"/><style>

</style></head><body>
<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MAHALLİ ANALİZ</title>
    <!-- PDF.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    </script>
    <!-- SheetJS (Excel) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- jsPDF & AutoTable (Comparison PDF Export) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #f8fafc;
            padding-bottom: 50px;
            color: #334155;
            margin: 0;
        }
        
        /* --- LANDING PAGE STYLES --- */
        #landing-page {
            position: fixed;
            inset: 0;
            z-index: 1000;
            background: #0f172a;
            background-image: 
                radial-gradient(circle at 20% 30%, rgba(37, 99, 235, 0.15) 0%, transparent 40%),
                radial-gradient(circle at 80% 70%, rgba(139, 92, 246, 0.15) 0%, transparent 40%);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: white;
            transition: transform 0.8s cubic-bezier(0.87, 0, 0.13, 1), opacity 0.6s ease;
            overflow-y: auto;
            padding: 2rem 1rem;
        }
        #landing-page.hidden {
            transform: translateY(-100%);
            opacity: 0;
            pointer-events: none;
        }
        .hero-container {
            max-width: 1100px;
            width: 100%;
            text-align: center;
        }
        .hero-badge {
            background: rgba(59, 130, 246, 0.1);
            border: 1px solid rgba(59, 130, 246, 0.2);
            color: #60a5fa;
            padding: 6px 16px;
            border-radius: 99px;
            font-size: 0.85rem;
            font-weight: 600;
            margin-bottom: 1.5rem;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        .feature-card {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.08);
            padding: 1.5rem;
            border-radius: 1.25rem;
            text-align: left;
            transition: all 0.3s ease;
        }
        .feature-card:hover {
            background: rgba(255, 255, 255, 0.06);
            transform: translateY(-5px);
            border-color: rgba(59, 130, 246, 0.3);
        }
        .feature-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
            margin-bottom: 1rem;
        }

        .sticky-wrapper {
            position: sticky;
            top: 0;
            z-index: 50;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        .sidebar {
            position: fixed; top: 0; left: 0; height: 100vh; width: 320px;
            background-color: #0f172a; color: #e2e8f0; z-index: 100;
            transform: translateX(-100%); transition: transform 0.3s ease-in-out;
            box-shadow: 4px 0 15px rgba(0,0,0,0.2); display: flex; flex-direction: column;
        }
        .sidebar.open { transform: translateX(0); }
        .sidebar-header { padding: 24px; border-bottom: 1px solid #1e293b; display: flex; justify-content: space-between; align-items: center; }
        .sidebar-menu { padding: 16px; flex: 1; overflow-y: auto; }
        
        .saved-project-item { 
            position: relative;
            background: #111827;
            border-radius: 12px; 
            margin-bottom: 16px; 
            cursor: pointer; 
            display: flex; 
            overflow: hidden; 
            padding: 3px;
            transition: all 0.3s ease;
            box-shadow: 0 0 10px rgba(30, 58, 138, 0.6), 0 0 20px rgba(59, 130, 246, 0.3);
        }

        .saved-project-item::before {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(135deg, #000080 0%, #1e3a8a 40%, #2563eb 75%, #3b82f6 100%);
            z-index: 0;
        }

        .saved-project-content {
            position: relative;
            background: linear-gradient(145deg, #1e293b 0%, #111827 100%);
            width: 100%;
            height: 100%;
            border-radius: 10px;
            padding: 14px;
            z-index: 1;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background 0.3s;
        }
        
        .saved-project-item:hover { 
            transform: scale(1.02);
            box-shadow: 0 0 15px rgba(30, 58, 138, 0.8), 0 0 25px rgba(59, 130, 246, 0.5);
        }

        .saved-project-item:hover .saved-project-content {
            background: linear-gradient(145deg, #334155 0%, #1e293b 100%);
        }

        .saved-project-info h4 { 
            font-weight: 700; 
            font-size: 0.95rem; 
            color: #f8fafc; 
            margin-bottom: 4px;
            line-height: 1.2;
        }
        
        .saved-project-info p { 
            font-size: 0.75rem; 
            color: #94a3b8; 
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .saved-project-info p i { font-size: 0.7rem; color: #64748b; }

        .action-icon-btn { 
            padding: 8px; 
            border-radius: 8px; 
            transition: all 0.2s; 
            cursor: pointer; 
            border: none; 
            background: rgba(255,255,255,0.05); 
            color: #94a3b8; 
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .action-icon-btn:hover { 
            background-color: rgba(255,255,255,0.15); 
            color: white; 
        }
        
        .action-icon-btn.delete-btn:hover {
            background-color: rgba(239, 68, 68, 0.2);
            color: #f87171;
        }

        .sidebar-footer { padding: 20px; border-top: 1px solid #1e293b; font-size: 0.75rem; text-align: center; color: #64748b; }
        .sidebar-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 90; opacity: 0; pointer-events: none; transition: opacity 0.3s ease; }
        .sidebar-overlay.show { opacity: 1; pointer-events: auto; }

        .top-banner {
            background-color: #0f172a; 
            color: #e2e8f0;
            padding: 12px 24px;
            border-bottom: 1px solid #334155;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .top-banner-title { font-size: 1.1rem; font-weight: 700; letter-spacing: 0.05em; color: white; display: flex; align-items: center; gap: 10px; }
        
        .global-search {
            background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.2); color: white; padding: 6px 12px; border-radius: 6px; font-size: 0.85rem; width: 250px; transition: all 0.3s;
        }
        .global-search:focus { outline: none; background: rgba(255, 255, 255, 0.2); border-color: rgba(255, 255, 255, 0.5); }
        .global-search::placeholder { color: #94a3b8; }

        .actions-group { display: flex; gap: 10px; align-items: center; }
        
        .btn-action {
            padding: 8px 14px;
            border-radius: 8px;
            font-size: 0.85rem;
            font-weight: 600;
            display: flex; align-items: center; gap: 8px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border: none;
            color: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .btn-action:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.25);
            filter: brightness(1.1);
        }

        .btn-save { background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%); }
        .btn-load { background: linear-gradient(135deg, #475569 0%, #334155 100%); }
        .btn-summary { background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); }
        .btn-compare { background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); }
        .btn-filter { background: linear-gradient(135deg, #06b6d4 0%, #0891b2 100%); }
        .btn-excel { background: linear-gradient(135deg, #10b981 0%, #059669 100%); }
        .btn-pdf { background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); }
        
        .btn-ops { background: #334155; color: #e2e8f0; border: 1px solid #475569; }

        .extra-actions-container { display: flex; gap: 10px; align-items: center; max-width: 0; overflow: hidden; opacity: 0; transition: all 0.4s ease; }
        .extra-actions-container.open { max-width: 700px; opacity: 1; margin-right: 10px; }

        .table-header { background: linear-gradient(135deg, #1e293b 0%, #334155 100%); border-bottom: 2px solid #475569; overflow-x: auto; }
        .table-header table { width: 100%; table-layout: fixed; }
        .table-header th { padding: 12px 8px; font-size: 0.75rem; font-weight: 700; text-transform: uppercase; color: #f1f5f9; text-align: left; border-right: 1px solid #475569; }
        
        .filter-header { background-color: #f8fafc; border-bottom: 1px solid #cbd5e1; padding: 8px 0; display: none; }
        .filter-header.active { display: block; }
        .filter-header table { width: 100%; table-layout: fixed; }
        .filter-header td { padding: 0 8px; }

        .data-table { width: 100%; table-layout: fixed; border-collapse: collapse; background-color: white; }
        .data-table td { padding: 10px 8px; font-size: 0.85rem; color: #334155; border-bottom: 1px solid #e2e8f0; border-right: 1px solid #e2e8f0; vertical-align: middle; word-wrap: break-word; }
        .data-table tr.highlighted td { background-color: #fff7ed !important; color: #ea580c; }
        .data-table tr:hover td { background-color: #f0f9ff; }

        .col-sira { width: 6%; text-align: center; } 
        .col-no { width: 9%; text-align: center; } 
        .col-tur { width: 8%; text-align: center; } 
        .col-ilce { width: 11%; } 
        .col-kat { width: 12%; } 
        .col-madde { width: 32%; } 
        .col-mud { width: 12%; } 
        .col-acik { width: 10%; }

        .filter-input { width: 100%; font-size: 0.75rem; padding: 6px; border: 1px solid #cbd5e1; border-radius: 4px; }
        
        .dropdown-content { display: none; position: absolute; background: white; min-width: 200px; max-height: 300px; overflow-y: auto; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); border-radius: 6px; padding: 8px; border: 1px solid #e2e8f0; z-index: 100; margin-top: 4px; }
        .dropdown-content.show { display: block; }
        .checkbox-label { display: flex; align-items: center; padding: 6px; cursor: pointer; font-size: 0.8rem; color: #475569; }
        .checkbox-label:hover { background-color: #f1f5f9; }
        .filter-dropdown-btn { width: 100%; font-size: 0.75rem; padding: 6px; border: 1px solid #cbd5e1; border-radius: 4px; background-color: white; text-align: left; display: flex; justify-content: space-between; align-items: center; color: #475569; cursor: pointer; }

        .modal-bg { position: fixed; inset: 0; background: rgba(15, 23, 42, 0.5); backdrop-filter: blur(2px); z-index: 200; display: flex; justify-content: center; align-items: center; }
        .modal-bg.hidden { display: none; }
        .modal-card { background: white; border-radius: 12px; padding: 24px; width: 90%; max-width: 450px; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1); }
        .delete-card { border-left: 5px solid #ef4444; }

        .summary-table { width: 100%; border-collapse: collapse; margin-bottom: 20px; font-size: 0.9rem; border-radius: 8px; overflow: hidden; }
        .summary-table th { color: #1e293b; font-weight: 700; padding: 12px; text-align: left; border: 1px solid #cbd5e1; }
        .summary-table td { padding: 10px 12px; border: 1px solid #cbd5e1; color: #334155; }
        .summary-table .total-row { font-weight: 800; background-color: rgba(0,0,0,0.05); }
        
        .stat-box { background-color: #f8fafc; border: 1px solid #e2e8f0; border-radius: 12px; padding: 20px; text-align: center; }
        .stat-value { font-size: 2rem; font-weight: 800; color: #0f172a; }
        .stat-label { font-size: 0.85rem; color: #64748b; font-weight: 600; text-transform: uppercase; }
        
        /* --- COMPARE MODAL SCROLLBAR FIX --- */
        #compare-modal { background-color: #f1f5f9; width: 100vw; height: 100vh; max-width: 100%; max-height: 100%; padding: 0; overflow: hidden; }
        .compare-modal-content { display: flex; flex-direction: column; height: 100%; }
        #compare-modal-body { flex: 1; overflow-y: auto; padding: 2rem; }
        
        .compare-section-title { font-size: 1.1rem; font-weight: 800; color: #1e293b; text-transform: uppercase; letter-spacing: 0.05em; }
        
        .compare-table-styled { width: 100%; border-collapse: collapse; background: white; border: 1px solid #e2e8f0; }
        .compare-table-styled th { background-color: #f1f5f9; color: #1e293b; font-weight: 700; padding: 14px; text-align: center; border: 1px solid #e2e8f0; font-size: 0.8rem; text-transform: uppercase; }
        .compare-table-styled td { padding: 12px 14px; border: 1px solid #e2e8f0; vertical-align: middle; color: #475569; }
        .compare-table-styled tr:hover { background-color: #f8fafc; }
        .compare-table-styled .row-header { font-weight: 700; color: #1e293b; background-color: #fafafa; text-align: left; }
        .compare-table-styled .total-cell { font-weight: 800; background-color: #f8fafc; text-align: center; }

        /* --- TABLO AKSİYONLARI --- */
        .table-container-wrapper { position: relative; background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); border: 1px solid #e2e8f0; margin-bottom: 24px; transition: all 0.3s ease; display: flex; flex-direction: column; }
        .table-container-wrapper.fullscreen { position: fixed; inset: 20px; z-index: 300; margin: 0; border-radius: 12px; height: calc(100vh - 40px); overflow: hidden; }
        .table-container-wrapper.fullscreen .compare-table-scroll { overflow: auto; flex: 1; }
        
        .table-header-actions { display: flex; justify-content: space-between; align-items: center; padding: 10px 16px; background: #fff; border-bottom: 1px solid #f1f5f9; }
        .action-icons-group { display: flex; gap: 8px; }
        .table-action-btn { width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; border-radius: 6px; cursor: pointer; transition: all 0.2s; color: #64748b; border: 1px solid #e2e8f0; background: #fff; }
        .table-action-btn:hover { background: #f8fafc; color: #2563eb; border-color: #2563eb; }

        .export-dropdown { position: relative; display: inline-block; }
        .export-menu { display: none; position: absolute; right: 0; top: 100%; background: white; min-width: 140px; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); border-radius: 8px; z-index: 310; border: 1px solid #e2e8f0; padding: 4px 0; margin-top: 5px; }
        .export-menu.show { display: block; }
        .export-item { padding: 8px 16px; font-size: 0.85rem; color: #475569; cursor: pointer; display: flex; align-items: center; gap: 10px; }
        .export-item:hover { background: #f1f5f9; color: #2563eb; }

        .bottom-bar { position: fixed; bottom: 0; left: 0; width: 100%; background: #ffffff; color: #64748b; text-align: center; padding: 12px; font-size: 0.8rem; font-weight: 600; border-top: 1px solid #e2e8f0; z-index: 40; }
        
        .badge { display: inline-block; padding: 2px 8px; border-radius: 4px; font-size: 0.70rem; font-weight: 700; text-transform: uppercase; }
        .badge-imar { background-color: #eff6ff; color: #1d4ed8; border: 1px solid #bfdbfe; }
        .badge-diger { background-color: #f8fafc; color: #64748b; border: 1px solid #e2e8f0; }
        .badge-tasinmaz { background-color: #fdf2f8; color: #be185d; border: 1px solid #fbcfe8; }
        .pdf-link { color: #334155; text-decoration: none; display: block; cursor: pointer; }

        /* Ada Parsel Aksiyonları */
        .ada-parsel-actions { display: flex; gap: 8px; margin-top: 6px; }
        .ap-btn { font-size: 0.7rem; display: flex; align-items: center; gap: 4px; padding: 3px 8px; border-radius: 4px; border: 1px solid #e2e8f0; background: #f8fafc; transition: all 0.2s; color: #64748b; text-decoration: none !important; }
        .ap-btn:hover { background: #fff; border-color: #2563eb; color: #2563eb; transform: translateY(-1px); }
        .ap-btn i { font-size: 0.8rem; }
    </style>
</head>
<body>

    <!-- LANDING PAGE -->
    <div id="landing-page">
        <div class="hero-container">
            <div class="hero-badge">
                <i class="fa-solid fa-shield-halved"></i> Profesyonel Meclis Takip Çözümü
            </div>
            <h1 class="text-5xl md:text-6xl font-extrabold mb-6 tracking-tight leading-tight">
                MAHALLİ <span class="text-blue-500"> ANALİZ </span>
            </h1>
            <p class="text-slate-400 text-xl mb-12 max-w-3xl mx-auto leading-relaxed">
                Belediye meclis gündemlerini yapay zeka destekli ayrıştırma ile analiz edin, raporlayın ve dönemler arası karşılaştırmalar yapın.
            </p>
            
            <div class="flex flex-col sm:flex-row gap-6 justify-center mb-20">
                <button onclick="document.getElementById('pdf-upload').click()" class="px-10 py-5 bg-blue-600 hover:bg-blue-700 text-white rounded-2xl font-bold shadow-[0_0_20px_rgba(37,99,235,0.4)] transition-all transform hover:scale-105 flex items-center justify-center gap-3 text-lg">
                    <i class="fa-solid fa-cloud-arrow-up"></i> PDF Yükle ve Başla
                </button>
                <button onclick="closeLanding()" class="px-10 py-5 bg-slate-800 hover:bg-slate-700 text-white rounded-2xl font-bold shadow-xl transition-all transform hover:scale-105 flex items-center justify-center gap-3 text-lg border border-slate-700">
                    <i class="fa-solid fa-table-columns"></i> Panele Git
                </button>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 px-4">
                <div class="feature-card">
                    <div class="feature-icon bg-blue-500/10 text-blue-500"><i class="fa-solid fa-bolt"></i></div>
                    <h3 class="text-lg font-bold mb-2">Hızlı Ayrıştırma</h3>
                    <p class="text-sm text-slate-400 leading-relaxed">Karmaşık PDF dosyalarını saniyeler içinde düzenli tablolara dönüştürün.</p>
                </div>
                <div class="feature-card">
                    <div class="feature-icon bg-purple-500/10 text-purple-500"><i class="fa-solid fa-filter"></i></div>
                    <h3 class="text-lg font-bold mb-2">Akıllı Filtreler</h3>
                    <p class="text-sm text-slate-400 leading-relaxed">İlçe, kategori ve müdürlük bazlı gelişmiş filtreleme seçeneklerini kullanın.</p>
                </div>
                <div class="feature-card">
                    <div class="feature-icon bg-amber-500/10 text-amber-500"><i class="fa-solid fa-scale-balanced"></i></div>
                    <h3 class="text-lg font-bold mb-2">Karşılaştırma</h3>
                    <p class="text-sm text-slate-400 leading-relaxed">Farklı dönemlerin gündemlerini yan yana getirerek trendleri izleyin.</p>
                </div>
                <div class="feature-card">
                    <div class="feature-icon bg-emerald-500/10 text-emerald-500"><i class="fa-solid fa-file-export"></i></div>
                    <h3 class="text-lg font-bold mb-2">Excel Raporlama</h3>
                    <p class="text-sm text-slate-400 leading-relaxed">Tüm verileri tek tıkla Excel formatında dışa aktarın ve paylaşın.</p>
                </div>
            </div>
        </div>
        <div class="mt-16 text-slate-500 text-sm font-medium flex items-center gap-4">
            <span>Saadet Partisi İstanbul İl Başkanlığı</span>
            <span class="w-1.5 h-1.5 bg-slate-700 rounded-full"></span>
            <span>v2.5 Enterprise</span>
        </div>
    </div>

    <!-- SIDEBAR -->
    <div id="sidebar-overlay" class="sidebar-overlay" onclick="toggleSidebar()"></div>
    <div id="sidebar" class="sidebar">
        <div class="sidebar-header">
            <h3 class="font-bold text-lg tracking-wide text-white uppercase flex items-center gap-2">
                <i class="fa-solid fa-folder-open text-blue-500"></i> Kayıtlı Projeler
            </h3>
            <button onclick="toggleSidebar()" class="text-slate-400 hover:text-white transition"><i class="fa-solid fa-xmark"></i></button>
        </div>
        <div id="saved-projects-list" class="sidebar-menu"><div class="px-4 py-8 text-center text-slate-500 text-sm">Henüz kayıtlı proje yok.</div></div>
        <div class="sidebar-footer">&copy; 2025 Meclis Gündem Aracı</div>
    </div>

    <!-- MODALLAR -->
    <div id="save-modal" class="modal-bg hidden">
        <div class="modal-card">
            <h3 class="text-lg font-bold text-slate-800 mb-4 flex items-center gap-2"><i class="fa-solid fa-floppy-disk text-blue-600"></i> Projeyi Kaydet</h3>
            <div class="mb-4"><label class="block text-sm font-medium text-slate-600 mb-1">Proje Adı</label><input type="text" id="project-name-input" class="w-full px-3 py-2 border border-slate-300 rounded-lg text-sm"></div>
            <div class="mb-6 flex items-start"><div class="flex items-center h-5"><input type="checkbox" id="save-as-file" class="w-4 h-4 text-blue-600 border-gray-300 rounded"></div><div class="ml-2 text-sm"><label for="save-as-file" class="font-medium text-slate-700">Yedekle</label><p class="text-xs text-slate-500">Bilgisayara (.json) indir.</p></div></div>
            <div class="flex justify-end gap-3"><button onclick="closeSaveModal()" class="px-4 py-2 text-slate-600 hover:bg-slate-100 rounded-lg text-sm font-medium">İptal</button><button onclick="confirmSaveProject()" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg text-sm font-medium shadow-md">Kaydet</button></div>
        </div>
    </div>

    <div id="delete-modal" class="modal-bg hidden">
        <div class="modal-card delete-card">
            <h3 class="text-lg font-bold text-slate-800 mb-2 flex items-center gap-2"><i class="fa-solid fa-trash-can text-red-600"></i> Projeyi Sil</h3>
            <p class="text-sm text-slate-600 mb-6">Bu projeyi silmek istediğinize emin misiniz?</p>
            <div class="flex justify-end gap-3"><button onclick="closeDeleteModal()" class="px-4 py-2 text-slate-600 hover:bg-slate-100 rounded-lg text-sm font-medium">Vazgeç</button><button onclick="confirmDeleteProject()" class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg text-sm font-medium shadow-md">Evet, Sil</button></div>
        </div>
    </div>

    <div id="category-modal" class="modal-bg hidden">
        <div class="modal-card">
            <h3 class="text-lg font-bold text-slate-800 mb-4 flex items-center gap-2"><i class="fa-solid fa-tags text-blue-600"></i> Kategori Ata</h3>
            <p class="text-sm text-slate-600 mb-4">Seçilen maddeler için yeni bir kategori belirleyin.</p>
            <div class="mb-4">
                <label class="block text-sm font-medium text-slate-600 mb-1">Kategori</label>
                <select id="category-select" class="w-full px-3 py-2 border border-slate-300 rounded-lg text-sm bg-white">
                    <option value="İmar İşlemleri">İmar İşlemleri</option>
                    <option value="Taşınmaz İşlemleri">Taşınmaz İşlemleri</option>
                    <option value="İsimlendirme">İsimlendirme</option>
                    <option value="Protokol İşlemleri">Protokol İşlemleri</option>
                    <option value="Ulaşım">Ulaşım</option>
                    <option value="Ödenek İşlemleri">Ödenek İşlemleri</option>
                    <option value="Mali Yardım">Mali Yardım</option>
                    <option value="Ücret Tespiti">Ücret Tespiti</option>
                    <option value="Görevlendirme">Görevlendirme</option>
                    <option value="Borçlanma">Borçlanma</option>
                    <option value="Bütçe İşlemleri">Bütçe İşlemleri</option>
                    <option value="Birim Adı Değişikliği">Birim Adı Değişikliği</option>
                    <option value="Diğer">Diğer</option>
                    <option value="custom">-- Yeni Kategori Ekle --</option>
                </select>
                <input type="text" id="custom-category-input" class="w-full mt-2 px-3 py-2 border border-slate-300 rounded-lg text-sm hidden" placeholder="Yeni kategori adı...">
            </div>
            <div class="flex justify-end gap-3"><button onclick="closeCategoryModal()" class="px-4 py-2 text-slate-600 hover:bg-slate-100 rounded-lg text-sm font-medium">İptal</button><button onclick="confirmAssignCategory()" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg text-sm font-medium shadow-md">Uygula</button></div>
        </div>
    </div>

    <!-- Karşılaştırma Modalı -->
    <div id="compare-modal" class="fixed inset-0 z-[200] hidden bg-slate-50">
        <div class="compare-modal-content">
            <div class="bg-slate-900 text-white p-4 flex justify-between items-center shadow-lg shrink-0">
                <div class="flex items-center gap-3"><i class="fa-solid fa-scale-balanced text-blue-400 text-xl"></i><h2 class="font-bold tracking-wide text-lg uppercase">Karşılaştırma Paneli</h2></div>
                <div class="flex items-center gap-4">
                    <div class="export-dropdown">
                        <button onclick="toggleExportMenu()" class="text-sm bg-blue-600 px-4 py-2 rounded-lg hover:bg-blue-700 transition flex items-center gap-2"><i class="fa-solid fa-file-export"></i> Dışa Aktar <i class="fa-solid fa-chevron-down text-[10px]"></i></button>
                        <div id="export-menu-list" class="export-menu">
                            <div class="export-item" onclick="bulkExport('pdf')"><i class="fa-solid fa-file-pdf text-red-500"></i> PDF Olarak</div>
                            <div class="export-item" onclick="bulkExport('word')"><i class="fa-solid fa-file-word text-blue-500"></i> Word Olarak</div>
                            <div class="export-item" onclick="bulkExport('excel')"><i class="fa-solid fa-file-excel text-green-500"></i> Excel Olarak</div>
                        </div>
                    </div>
                    <button onclick="closeCompare()" class="text-sm bg-white/10 px-4 py-2 rounded-lg hover:bg-white/20 transition">Kapat</button>
                </div>
            </div>
            <div id="compare-modal-body">
                <div class="max-w-7xl mx-auto">
                    <div id="compare-upload-section" class="mb-6 text-center p-8 bg-white rounded-xl border-2 border-dashed border-slate-300 hover:border-blue-500 transition cursor-pointer" onclick="document.getElementById('compare-upload').click()">
                        <input type="file" id="compare-upload" accept=".pdf" multiple class="hidden" />
                        <i class="fa-solid fa-cloud-arrow-up text-4xl text-slate-300 mb-3"></i>
                        <p class="text-lg font-medium text-slate-700">Dosyaları Seçin veya Sürükleyin</p>
                        <p class="text-sm text-slate-500">Otomatik tarih sıralaması yapılır.</p>
                    </div>
                    <div id="compare-results" class="hidden space-y-8 pb-12"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Özet Modalı -->
    <div id="summary-modal" class="fixed inset-0 z-[200] hidden bg-slate-50 flex flex-col">
        <div class="bg-slate-900 text-white p-4 flex justify-between items-center shadow-lg"><div class="flex items-center gap-3"><i class="fa-solid fa-chart-pie text-amber-400 text-xl"></i><h2 class="font-bold tracking-wide text-lg">ÖZET TABLOSU</h2></div><button onclick="closeSummary()" class="text-sm bg-white/10 px-4 py-2 rounded-lg hover:bg-white/20">Kapat</button></div>
        <div class="flex-1 overflow-y-auto p-8"><div id="summary-content" class="max-w-7xl mx-auto space-y-8"></div></div>
    </div>

    <!-- MAIN UI -->
    <div class="sticky-wrapper">
        <div class="top-banner">
            <div class="flex items-center gap-4">
                <button onclick="toggleSidebar()" class="menu-toggle-btn text-slate-400 hover:text-white transition"><i class="fa-solid fa-bars text-lg"></i></button>
                <div class="text-white font-bold text-lg tracking-tight flex items-center gap-2"><i class="fa-solid fa-building-columns text-blue-500"></i> MECLİS GÜNDEM ARACI</div>
                <div class="relative hidden md:block ml-4"><i class="fa-solid fa-magnifying-glass absolute left-3 top-2.5 text-slate-400 text-xs"></i><input type="text" id="globalSearch" onkeyup="globalSearchTable()" placeholder="Ara..." class="global-search pl-8"></div>
            </div>
            <div class="actions-group">
                <button onclick="toggleExtraActions()" id="extra-actions-btn" class="btn-action btn-ops">İşlemler <i class="fa-solid fa-chevron-down text-xs ml-1"></i></button>
                <div id="extra-actions-container" class="extra-actions-container">
                    <button onclick="openCategoryModal()" id="btn-bulk-category" class="hidden btn-action bg-indigo-600 text-white border-indigo-600 hover:bg-indigo-700">Kategori Ata</button>
                    <button onclick="openSaveModal()" class="btn-action btn-save"><i class="fa-solid fa-floppy-disk"></i> Kaydet</button>
                    <label class="btn-action btn-load cursor-pointer"><input type="file" id="json-upload" accept=".json" class="hidden" onchange="loadProject(this)" /><i class="fa-solid fa-file-import"></i> Yükle</label>
                    <button onclick="showSummary()" class="btn-action btn-summary"><i class="fa-solid fa-chart-simple"></i> Özet</button>
                    <button onclick="openCompare()" class="btn-action btn-compare"><i class="fa-solid fa-scale-balanced"></i> Karşılaştır</button>
                </div>
                <button onclick="toggleFilters()" id="filter-btn" class="btn-action btn-filter"><i class="fa-solid fa-filter"></i> Filtrele</button>
                <button onclick="exportToExcel()" class="btn-action btn-excel"><i class="fa-solid fa-file-excel"></i> Excel</button>
                <label class="btn-action btn-pdf cursor-pointer"><input type="file" id="pdf-upload" accept=".pdf" class="hidden" /><i class="fa-solid fa-file-pdf"></i> PDF Yükle</label>
            </div>
        </div>

        <div class="table-header">
            <table><thead><tr>
                <th class="col-sira"><div class="flex flex-col items-center justify-center gap-1"><span>NO</span><input type="checkbox" id="select-all" onchange="toggleSelectAll(this)" style="cursor: pointer;"></div></th>
                <th class="col-no">Gündem No</th><th class="col-tur">Tür</th><th class="col-ilce">İlçe</th><th class="col-kat">Kategori</th><th class="col-madde">Gündem Maddesi</th><th class="col-mud">Teklif Veren</th><th class="col-acik">Açıklama</th>
            </tr></thead></table>
        </div>
        
        <div id="filter-row" class="filter-header">
            <table><tr>
                <td class="col-sira"><input type="text" onkeyup="filterTableText(0)" class="filter-input" placeholder="#"></td>
                <td class="col-no"><input type="text" onkeyup="filterTableText(1)" class="filter-input" placeholder="No"></td>
                <td class="col-tur relative"><button onclick="event.stopPropagation();toggleDropdown('dd-tur')" id="btn-tur" class="filter-dropdown-btn"><span>Tümü</span> <i class="fa-solid fa-chevron-down"></i></button><div id="dd-tur" class="dropdown-content"></div></td>
                <td class="col-ilce relative"><button onclick="event.stopPropagation();toggleDropdown('dd-ilce')" id="btn-ilce" class="filter-dropdown-btn"><span>Tümü</span> <i class="fa-solid fa-chevron-down"></i></button><div id="dd-ilce" class="dropdown-content"></div></td>
                <td class="col-kat relative"><button onclick="event.stopPropagation();toggleDropdown('dd-kat')" id="btn-kat" class="filter-dropdown-btn"><span>Tümü</span> <i class="fa-solid fa-chevron-down"></i></button><div id="dd-kat" class="dropdown-content"></div></td>
                <td class="col-madde"><input type="text" onkeyup="filterTableText(5)" class="filter-input" placeholder="İçerik ara..."></td>
                <td class="col-mud relative"><button onclick="event.stopPropagation();toggleDropdown('dd-mudurluk')" id="btn-mudurluk" class="filter-dropdown-btn"><span>Tümü</span> <i class="fa-solid fa-chevron-down"></i></button><div id="dd-mudurluk" class="dropdown-content"></div></td>
                <td class="col-acik"><input type="text" onkeyup="filterTableText(7)" class="filter-input" placeholder="..."></td>
            </tr></table>
        </div>
    </div>

    <div class="data-container">
        <table id="main-table" class="data-table">
            <tbody id="result-body">
                <!-- JS ile doldurulacak -->
            </tbody>
        </table>
    </div>

    <div class="bottom-bar">Saadet Partisi İstanbul İl Başkanlığı</div>

<script>
    function closeLanding() {
        document.getElementById('landing-page').classList.add('hidden');
    }

    const ILCELER = ["Adalar", "Arnavutköy", "Ataşehir", "Avcılar", "Bağcılar", "Bahçelievler", "Bakırköy", "Başakşehir", "Bayrampaşa", "Beşiktaş", "Beykoz", "Beylikdüzü", "Beyoğlu", "Büyükçekmece", "Çatalca", "Çekmeköy", "Esenler", "Esenyurt", "Eyüpsultan", "Eyüp", "Fatih", "Gaziosmanpaşa", "Güngören", "Kadıköy", "Kağıthane", "Kartal", "Küçükçekmece", "Maltepe", "Pendik", "Sancaktepe", "Sarıyer", "Silivri", "Sultanbeyli", "Sultangazi", "Şile", "Şişli", "Tuzla", "Ümraniye", "Üsküdar", "Zeytinburnu"];
    let allItems = [], activeFilters = { 0: "", 1: "", 2: [], 3: [], 4: [], 5: "", 6: [], 7: "" }, globalPdfUrl = null, projectToDeleteId = null, currentLoadedFileName = "", selectedRows = new Set(); 

    function toTitleCase(str) { if (!str) return ""; return str.toLocaleLowerCase('tr').split(" ").map(w => w.charAt(0).toLocaleUpperCase('tr') + w.slice(1)).join(" "); }
    function fixBrokenWords(text) { if (!text) return ""; return text.replace(/\b(?:[a-zA-ZğüşıöçĞÜŞİÖÇİ]\s+){2,}[a-zA-ZğüşıöçĞÜŞİÖÇİ]\b/g, m => m.replace(/\s+/g, '')).replace(/\s+/g, ' ').trim(); }
    function formatDisplayFileName(n) { let c = n.replace(/\.pdf$/i, ''); const m = c.match(/^(\d{1,2})_([A-Za-zçğıöşüÇĞİÖŞÜ]+)_(\d{4})/); if (m) { let d = m[1], mo = m[2], y = m[3]; mo = mo.charAt(0).toUpperCase() + mo.slice(1).toLowerCase(); return `${parseInt(d)} ${mo} ${y} Gündemi`; } return c.substring(0, 25) + (c.length > 25 ? '...' : ''); }
    
    function getBadgeClass(c) { 
        if (!c) return 'badge-diger'; 
        const ct = c.toLocaleUpperCase('tr');
        if (ct.includes('İMAR')) return 'badge-imar'; 
        if (ct.includes('TAŞINMAZ')) return 'badge-tasinmaz'; 
        if (ct.includes('İSİMLENDİRME')) return 'bg-indigo-50 text-indigo-700 border-indigo-200';
        return 'badge-diger'; 
    }
    
    function determineCategory(t) {
        t = t.toLocaleLowerCase('tr');
        if (t.includes('ulaşım proje ve yatırım hizmet bedeli')) return 'Ulaşım';
        if (t.includes('birim adı değişikliği')) return 'Birim Adı Değişikliği';
        if (t.includes('yol iptalleri')) return 'Yol Ve Aks İşlemleri';
        if (t.includes('aks değişikliği')) return 'Yol Aks İşlemleri';
        if (t.includes('fazla çalışma ücreti')) return 'Ücret İşlemleri';
        if (t.includes('bütçe')) return 'Bütçe İşlemleri';
        if (t.includes('ödenek')) return 'Ödenek İşlemleri';
        if (t.includes('parsel') || t.includes('konut kira bedelleri')) return 'Taşınmaz işlemleri';
        if ((t.includes('isimsiz yolun') || t.includes('isimsiz yolların')) && t.includes('isimlendirmesi')) return 'İsimlendirme';
        if (t.includes('protokol')) return 'Protokol İşlemleri';
        if (t.includes('toplu ulaşım karayolları')) return 'Ulaşım';
        if (t.includes('ölünceye kadar bakma sözleşmesi')) return 'Ölünceye Kadar Bakma Sözleşmesi';
        if (t.includes('denetim komisyonuna üye seçimi')) return 'Üye Seçimi';
        if (t.includes('ücret tespiti')) return 'Ücret Tespiti';
        if (t.includes('görev bölümü')) return 'Görevlendirme';
        if (t.includes('borçlanma')) return 'Borçlanma';
        if (t.includes('yol aks değişikliği') || t.includes('aks kısaltılması') || t.includes('aks uzatılması') || t.includes('yol isimlendirilmesi') || (t.includes('isimlendirme') && t.includes('aks'))) return 'İsimlendirme Ve Yol Aks İşlemleri';
        if (t.includes('yol isim değişikliği') || t.includes('isimsiz yolun isimlendirilmesi') || (t.includes('sokağı') && t.includes('isminin'))) return 'İsimlendirme';
        if (t.includes('yol') && t.includes('aks')) return 'Yol Ve Aks İşlemleri';
        if (t.includes('iş birliği protokolü')) return 'Protokol işlemleri';
        if ((t.includes('ada') && t.includes('parsel')) || t.includes('kullanım hakkı verilmesi') || t.includes('takas trampa') || t.includes('taşınmazların satışı') || t.includes('tahsis') || (t.includes('satışı') && t.includes('kiralama')) || t.includes('devir')) return 'Taşınmaz işlemleri';
        if (t.includes('ölünceye kadar bakım')) return 'Ölünceye Kadar Bakım';
        if (t.includes('engelliler şube müdürlüğü')) return 'Müdürlük İsim Değişikliği';
        if (t.includes('mali yardım')) return 'Mali Yardım';
        if (t.includes('personel tespit ücreti')) return 'personel ücret';
        if (t.includes('kadro ihtası')) return 'Kadro İşlemleri';
        if (t.includes('iett')) return 'Ulaştırma';
        if (t.includes('ücret tarifesi')) return 'ücret tarifesi';
        if (t.includes('kuip') || t.includes('nip') || t.includes('rip') || t.includes('ölçek')) return 'imar işlemleri';
        if (t.includes('imar')) return 'İmar İşlemleri';
        return 'Diğer';
    }

    function updateFilter(col, cid, bid) {
        const checkboxes = document.getElementById(cid).querySelectorAll('input:checked');
        const ch = Array.from(checkboxes).map(c => c.value);
        activeFilters[col] = ch;
        const b = document.getElementById(bid).querySelector('span');
        if (b) {
            b.textContent = ch.length === 0 ? 'Tümü' : `${ch.length} Seçili`;
            b.style.color = ch.length > 0 ? '#2563eb' : 'inherit';
            b.style.fontWeight = ch.length > 0 ? 'bold' : 'normal';
        }
        applyAllFilters();
    }

    function applyAllFilters() {
        const body = document.getElementById('result-body');
        const rows = Array.from(body.children);
        if (rows.length === 0) return;
        rows.forEach(r => {
            let show = true;
            for (let [cIndexStr, filterValue] of Object.entries(activeFilters)) {
                const cIndex = parseInt(cIndexStr);
                const cell = r.children[cIndex];
                if (!cell) continue;
                const cellTextNormalized = cell.innerText.trim().toLocaleUpperCase('tr');
                if (Array.isArray(filterValue) && filterValue.length > 0) {
                    const normalizedFilterArray = filterValue.map(v => v.toLocaleUpperCase('tr'));
                    if (!normalizedFilterArray.includes(cellTextNormalized)) { show = false; break; }
                } else if (!Array.isArray(filterValue) && filterValue !== "") {
                    if (!cellTextNormalized.includes(filterValue)) { show = false; break; }
                }
            }
            r.style.display = show ? '' : 'none';
        });
    }

    function createCheckboxList(items, key, containerId, btnId, colIndex) {
        const u = [...new Set(items.map(i => i[key]).filter(x => x))].sort((a, b) => a.localeCompare(b, 'tr'));
        const c = document.getElementById(containerId); if (!c) return; c.innerHTML = '';
        const clr = document.createElement('div'); clr.className = 'p-2 text-xs font-bold text-red-500 cursor-pointer border-b hover:bg-red-50'; clr.innerText = 'Temizle'; clr.onclick = () => { c.querySelectorAll('input').forEach(i => i.checked = false); updateFilter(colIndex, containerId, btnId); }; c.appendChild(clr);
        u.forEach(v => {
            const l = document.createElement('label'); l.className = 'checkbox-label';
            l.innerHTML = `<input type="checkbox" value="${v}" onchange="updateFilter(${colIndex},'${containerId}','${btnId}')"> <span class="ml-2">${v}</span>`;
            c.appendChild(l);
        });
    }

    function populateCheckboxes() { 
        createCheckboxList(allItems, 'gundemTuru', 'dd-tur', 'btn-tur', 2); 
        createCheckboxList(allItems, 'ilce', 'dd-ilce', 'btn-ilce', 3); 
        createCheckboxList(allItems, 'kategori', 'dd-kat', 'btn-kat', 4);
        createCheckboxList(allItems, 'mudurluk', 'dd-mudurluk', 'btn-mudurluk', 6); 
    }

    function renderTable(items) {
        const b = document.getElementById('result-body'); if (!b) return;
        if (items.length === 0) { b.innerHTML = `<tr><td colspan="8" class="p-24 text-center text-slate-400 flex flex-col items-center justify-center cursor-pointer hover:text-blue-600 transition" onclick="document.getElementById('pdf-upload').click()"><i class="fa-solid fa-file-arrow-up text-6xl mb-4 opacity-30"></i><span class="font-medium text-lg">Başlamak için bir PDF dosyası yükleyin</span></td></tr>`; return; }
        b.innerHTML = items.map((x, i) => `
            <tr onclick="this.classList.toggle('highlighted')" class="${i % 2 === 0 ? 'bg-white' : 'bg-slate-50'} hover:bg-blue-50 transition border-b border-slate-100">
                <td class="col-sira font-bold text-slate-700 text-center border-r border-slate-200">
                    <div class="flex flex-col items-center justify-center gap-1">
                        <span class="text-sm">${x.siraNo}</span>
                        <input type="checkbox" class="row-select-cb" value="${i}" onchange="handleRowSelect(this, ${i})" ${selectedRows.has(i) ? 'checked' : ''} onclick="event.stopPropagation()">
                    </div>
                </td>
                <td class="col-no text-xs text-center font-mono text-blue-600 bg-blue-50/50 rounded mx-1">${x.gundemSayiNo}</td>
                <td class="col-tur text-[10px] text-center font-bold uppercase tracking-wide text-slate-500">${x.gundemTuru}</td>
                <td class="col-ilce text-sm font-semibold text-slate-800">${x.ilce}</td>
                <td class="col-kat text-xs text-center font-bold" onclick="event.stopPropagation(); openCategoryModalForSingle(${i})">
                    <span class="badge ${getBadgeClass(x.kategori)} cursor-pointer hover:brightness-90 transition">${x.kategori}</span>
                </td>
                <td class="col-madde text-sm text-slate-700 leading-snug">
                    <a href="${globalPdfUrl || '#'}" target="_blank" class="pdf-link hover:text-blue-600 transition">${x.maddeMetni}</a>
                    ${x.hasAdaParsel ? `
                    <div class="ada-parsel-actions" onclick="event.stopPropagation()">
                        <a href="https://www.google.com/maps/search/İstanbul+${x.ilce}+${x.ada}+Ada+${x.parsel}+Parsel" target="_blank" class="ap-btn" title="Haritada Konumu Gör">
                            <i class="fa-solid fa-map-location-dot text-red-500"></i> Google Maps
                        </a>
                        <a href="https://parselsorgu.tkgm.gov.tr/" target="_blank" class="ap-btn" title="TKGM Parsel Sorgu">
                            <i class="fa-solid fa-earth-americas text-blue-500"></i> TKGM Tapu
                        </a>
                    </div>` : ''}
                </td>
                <td class="col-mud text-xs font-semibold text-slate-600 uppercase">${x.mudurluk}</td>
                <td class="col-acik text-sm text-slate-500 italic" contenteditable="true"></td>
            </tr>`).join('');
    }

    function toggleSelectAll(cb) { const cbs = document.querySelectorAll('.row-select-cb'); selectedRows.clear(); cbs.forEach((c, i) => { c.checked = cb.checked; if (cb.checked) selectedRows.add(i); }); updateBulkBtn(); }
    function handleRowSelect(cb, i) { if (cb.checked) selectedRows.add(i); else selectedRows.delete(i); updateBulkBtn(); }
    function updateBulkBtn() { const b = document.getElementById('btn-bulk-category'); if (selectedRows.size > 0) { b.classList.remove('hidden'); b.innerHTML = `<i class="fa-solid fa-tags"></i> Kategori Ata (${selectedRows.size})`; } else b.classList.add('hidden'); }
    
    let singleEditIndex = null;
    function openCategoryModal() { if (selectedRows.size) { singleEditIndex = null; document.getElementById('category-modal').classList.remove('hidden'); } }
    function openCategoryModalForSingle(i) { singleEditIndex = i; document.getElementById('category-modal').classList.remove('hidden'); }
    function closeCategoryModal() { document.getElementById('category-modal').classList.add('hidden'); singleEditIndex = null; }
    
    function confirmAssignCategory() { 
        let c = document.getElementById('category-select').value; 
        if (c === 'custom') c = document.getElementById('custom-category-input').value.trim(); 
        if (!c) return; 
        if (singleEditIndex !== null) { allItems[singleEditIndex].kategori = c; } 
        else { Array.from(selectedRows).forEach(i => { if (allItems[i]) allItems[i].kategori = c; }); selectedRows.clear(); document.getElementById('select-all').checked = false; }
        renderTable(allItems); populateCheckboxes(); updateBulkBtn(); applyAllFilters(); closeCategoryModal(); 
    }
    
    function updateSidebarList() { 
        const p = JSON.parse(localStorage.getItem('savedProjects') || "[]"); 
        const l = document.getElementById('saved-projects-list'); if(!l) return; 
        if (p.length === 0) l.innerHTML = '<div class="px-4 py-8 text-center text-slate-500 text-sm">Henüz kayıtlı proje yok.</div>';
        else l.innerHTML = p.map(x => `
            <div class="saved-project-item">
                <div class="saved-project-content">
                    <div class="saved-project-info" onclick="loadSavedProject(${x.id})"><h4>${x.name}</h4><p><i class="fa-regular fa-calendar-days"></i> ${x.date}</p></div>
                    <div class="project-actions flex gap-2">
                        <button class="action-icon-btn load-btn" onclick="loadSavedProject(${x.id})"><i class="fa-solid fa-arrow-up-from-bracket"></i></button>
                        <button class="action-icon-btn delete-btn" onclick="openDeleteModal(${x.id}, event)"><i class="fa-solid fa-trash-can"></i></button>
                    </div>
                </div>
            </div>`).join('');
    }

    function analyzeItem(s, t, g) { 
        let ct = fixBrokenWords(t).replace(/\bSayfa\s+[\d\s\/]+\b/gi, '').replace(/\s+/g, ' ').trim(); 
        const cat = determineCategory(ct), pm = ct.match(/\(([^)]+)\)/g), gn = pm ? pm[pm.length - 1].replace(/[()]/g, '') : ""; 
        let il = "", mu = ""; 
        for (const i of ILCELER) { if (ct.toLocaleLowerCase('tr').includes(i.toLocaleLowerCase('tr'))) { il = i; break; } }
        const bm = ct.match(/([a-zA-ZğüşıöçĞÜŞİÖÇ\s]+Belediye Başkanlığı)\s+teklifi/i);
        if (bm) { for (const i of ILCELER) { if (bm[1].toLocaleLowerCase('tr').includes(i.toLocaleLowerCase('tr'))) { il = i; break; } } }
        const mm = ct.match(/([^,.]*?(?:Müdürlüğü|Dairesi Başkanlığı|Daire Başkanlığı))\s+teklifi/i);
        if (mm) mu = mm[1].trim();

        // Ada Parsel Tespiti ve Bilgi Çekimi (Regex iyileştirildi)
        const adaMatch = ct.match(/\b(\d+)\s*ada\b/i);
        const parselMatch = ct.match(/\b(\d+)\s*parsel\b/i);
        const hasAdaParsel = adaMatch && parselMatch;

        return { 
            siraNo: s, 
            gundemSayiNo: gn, 
            gundemTuru: g, 
            ilce: toTitleCase(il), 
            kategori: toTitleCase(cat), 
            maddeMetni: ct, 
            mudurluk: toTitleCase(mu),
            hasAdaParsel: !!hasAdaParsel,
            ada: adaMatch ? adaMatch[1] : "",
            parsel: parselMatch ? parselMatch[1] : "",
            mapLink: '' 
        }; 
    }

    function parseLinesToItems(l) { 
        let it = [], m = "Olağan", c = null; 
        const headersToIgnore = ["TEKLİFLER", "BAŞKANLIK EK TEKLİFLERİ", "BAŞKANLIK TEKLİFLERİ", "GÜNDEM"];
        for (let x of l) { 
            x = x.trim(); if (!x) continue;
            const up = x.toLocaleUpperCase('tr');
            if (headersToIgnore.some(h => up.includes(h)) && x.length < 50) { if (up.includes("BAŞKANLIK EK")) m = "Ek Gündem"; continue; }
            const mt = x.match(/^(\d{1,3})\.\s+(.*)/);
            if (mt && !/^\d/.test(mt[2].trim()) && mt[2].trim().length > 3) {
                if (c) it.push(analyzeItem(c.s, c.t, c.m));
                c = { s: mt[1], t: mt[2], m: m };
            } else if (c) { c.t += " " + x; }
        }
        if (c) it.push(analyzeItem(c.s, c.t, c.m));
        return it.filter((v, i, a) => a.findIndex(t => t.siraNo === v.siraNo && t.maddeMetni === v.maddeMetni) === i); 
    }

    window.addEventListener('load', () => {
        updateSidebarList(); renderTable([]);
        window.onclick = e => { if (!e.target.closest('button') && !e.target.closest('input[type="checkbox"]')) {
            document.querySelectorAll('.dropdown-content').forEach(d => d.classList.remove('show'));
            document.getElementById('export-menu-list').classList.remove('show');
        }};
        document.getElementById('category-select').addEventListener('change', function() { const i = document.getElementById('custom-category-input'); if (this.value === 'custom') { i.classList.remove('hidden'); i.focus(); } else i.classList.add('hidden'); });
    });

    window.addEventListener('keydown', e => {
        if(e.key === 'Escape') {
            closeSummary();
            closeCompare();
            closeSaveModal();
            closeDeleteModal();
            closeCategoryModal();
        }
    });

    function toggleFilters() { document.getElementById('filter-row').classList.toggle('active'); }
    function toggleDropdown(id) { document.querySelectorAll('.dropdown-content').forEach(d => { if (d.id !== id) d.classList.remove('show') }); const el = document.getElementById(id); if(el) el.classList.toggle('show'); }
    function filterTableText(col) { 
        const inputs = document.getElementById('filter-row').querySelectorAll('input');
        let val = (col === 0) ? inputs[0].value : (col === 1) ? inputs[1].value : (col === 5) ? inputs[2].value : inputs[3].value;
        activeFilters[col] = val.toLocaleUpperCase('tr'); applyAllFilters(); 
    }
    function globalSearchTable() { const q = document.getElementById('globalSearch').value.toLocaleUpperCase('tr'); Array.from(document.getElementById('result-body').children).forEach(r => r.style.display = r.innerText.toLocaleUpperCase('tr').includes(q) ? '' : 'none'); }
    function toggleExtraActions(){const c=document.getElementById('extra-actions-container');c.classList.toggle('open');}
    function toggleSidebar(){const s=document.getElementById('sidebar');s.classList.toggle('open');document.getElementById('sidebar-overlay').classList.toggle('show');}
    function closeSaveModal(){document.getElementById('save-modal').classList.add('hidden');}
    function closeDeleteModal(){document.getElementById('delete-modal').classList.add('hidden');}
    function closeCompare(){document.getElementById('compare-modal').classList.add('hidden');}
    function closeSummary(){document.getElementById('summary-modal').classList.add('hidden');}
    function openSaveModal() { if (allItems.length === 0) return; document.getElementById('save-modal').classList.remove('hidden'); document.getElementById('project-name-input').value = currentLoadedFileName ? formatDisplayFileName(currentLoadedFileName) : new Date().toLocaleDateString('tr-TR') + " Meclis Gündemi"; }
    function openDeleteModal(id, e) { if(e) e.stopPropagation(); projectToDeleteId = id; document.getElementById('delete-modal').classList.remove('hidden'); }
    function openCompare() { document.getElementById('compare-modal').classList.remove('hidden'); }
    function loadSavedProject(id) { const p = JSON.parse(localStorage.getItem('savedProjects') || "[]").find(x => x.id === id); if (p) { allItems = p.data; renderTable(allItems); populateCheckboxes(); if (document.getElementById('sidebar').classList.contains('open')) toggleSidebar(); closeLanding(); } }
    function confirmSaveProject() { const n = document.getElementById('project-name-input').value.trim(); if (!n) return; let p = JSON.parse(localStorage.getItem('savedProjects') || "[]"); p.push({ id: Date.now(), name: n, date: new Date().toLocaleString('tr-TR'), data: allItems }); localStorage.setItem('savedProjects', JSON.stringify(p)); updateSidebarList(); closeSaveModal(); toggleSidebar(); }
    function confirmDeleteProject() { if (projectToDeleteId) { let p = JSON.parse(localStorage.getItem('savedProjects') || "[]"); p = p.filter(x => x.id !== Number(projectToDeleteId)); localStorage.setItem('savedProjects', JSON.stringify(p)); updateSidebarList(); closeDeleteModal(); } }
    
    // --- TABLO AKSİYONLARI ---
    function toggleTableFullscreen(id) { document.getElementById(id).classList.toggle('fullscreen'); }
    function copyTableToClipboard(id) {
        const table = document.getElementById(id).querySelector('table');
        const range = document.createRange();
        range.selectNode(table);
        window.getSelection().removeAllRanges();
        window.getSelection().addRange(range);
        document.execCommand('copy');
        window.getSelection().removeAllRanges();
    }
    function saveTableExcel(id, title) { 
        const table = document.getElementById(id).querySelector('table');
        const wb = XLSX.utils.table_to_book(table);
        XLSX.writeFile(wb, `${title}.xlsx`);
    }

    // --- KARŞILAŞTIRMA BÖLÜMÜ TOPLU DIŞA AKTARIM ---
    function toggleExportMenu() { document.getElementById('export-menu-list').classList.toggle('show'); event.stopPropagation(); }
    
    function bulkExport(type) {
        const wrapper = document.getElementById('compare-results');
        const tables = Array.from(wrapper.querySelectorAll('table'));
        if (!tables.length) return;

        if (type === 'excel') {
            const wb = XLSX.utils.book_new();
            tables.forEach((t, i) => {
                const ws = XLSX.utils.table_to_sheet(t);
                XLSX.utils.book_append_sheet(wb, ws, `Tablo_${i+1}`);
            });
            XLSX.writeFile(wb, "Meclis_Karsilastirma_Raporu.xlsx");
        } 
        else if (type === 'pdf') {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('l', 'pt');
            tables.forEach((t, i) => {
                if (i > 0) doc.addPage();
                doc.autoTable({ html: t, theme: 'grid', styles: { fontSize: 8, cellPadding: 2 } });
            });
            doc.save("Meclis_Karsilastirma_Raporu.pdf");
        } 
        else if (type === 'word') {
            let html = `<html><head><meta charset='utf-8'></head><body>`;
            tables.forEach(t => html += `<table border='1' style='border-collapse:collapse; width:100%; font-family:sans-serif;'>${t.innerHTML}</table><br><br>`);
            html += `</body></html>`;
            const blob = new Blob(['\ufeff', html], { type: 'application/msword' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a'); a.href = url; a.download = "Meclis_Karsilastirma_Raporu.doc"; a.click();
        }
    }

    document.getElementById('pdf-upload').addEventListener('change', async e => { 
        const file = e.target.files[0]; if (!file) return; 
        globalPdfUrl = URL.createObjectURL(file); currentLoadedFileName = file.name; closeLanding(); 
        try { 
            const ab = await file.arrayBuffer(); const pdf = await pdfjsLib.getDocument(ab).promise; let l = []; 
            for (let i = 1; i <= pdf.numPages; i++) { 
                const t = await (await pdf.getPage(i)).getTextContent(); 
                let ly = -1, lt = ""; 
                const s = t.items.sort((a, b) => Math.abs(a.transform[5] - b.transform[5]) < 8 ? a.transform[4] - b.transform[4] : b.transform[5] - a.transform[5]); 
                for (const x of s) { if (ly === -1) { ly = x.transform[5]; lt = x.str; } else if (Math.abs(x.transform[5] - ly) > 8) { l.push(lt); lt = x.str; ly = x.transform[5]; } else { lt += x.str; } } if (lt) l.push(lt); 
            } 
            allItems = parseLinesToItems(l); renderTable(allItems); populateCheckboxes(); 
        } catch (er) { alert("PDF işlenirken hata oluştu."); } finally { e.target.value = ''; }
    });

    document.getElementById('compare-upload').addEventListener('change', async e => {
        const fs = Array.from(e.target.files); if (!fs.length) return;
        const monthMap = { "ocak": 0, "subat": 1, "şubat": 1, "mart": 2, "nisan": 3, "mayis": 4, "mayıs": 4, "haziran": 5, "temmuz": 6, "agustos": 7, "ağustos": 7, "eylul": 8, "eylül": 8, "ekim": 9, "kasim": 10, "kasım": 10, "aralik": 11, "aralık": 11 };
        const cont = document.getElementById('compare-results'); cont.classList.remove('hidden'); cont.innerHTML = '';
        let allRes = []; 
        for (const f of fs) {
            try {
                const ab = await f.arrayBuffer(); const pdf = await pdfjsLib.getDocument(ab).promise; let l = []; for(let i=1;i<=pdf.numPages;i++){const t=await(await pdf.getPage(i)).getTextContent();let ly=-1,lt="";const s=t.items.sort((a,b)=>Math.abs(a.transform[5]-b.transform[5])<8?a.transform[4]-b.transform[4]:b.transform[5]-a.transform[5]);for(const x of s){if(ly===-1){ly=x.transform[5];lt=x.str;}else if(Math.abs(x.transform[5]-ly)>8){l.push(lt);lt=x.str;ly=x.transform[5];}else{lt+=x.str;}}if(lt)l.push(lt);}
                allRes.push({ name: f.name, data: parseLinesToItems(l) });
            } catch (err) { console.error(err); }
        }

        allRes.sort((a, b) => {
            const parseD = (n) => {
                const m = n.match(/^(\d{1,2})_([A-Za-zçğıöşüÇĞİÖŞÜ]+)_(\d{4})/i);
                if (m) {
                    const d = parseInt(m[1]), y = parseInt(m[3]), mon = monthMap[m[2].toLowerCase()] || 0;
                    return new Date(y, mon, d);
                }
                return new Date(0);
            };
            return parseD(a.name) - parseD(b.name);
        });
        
        let genHtml = `<div class="table-container-wrapper" id="comp-wrapper-gen">
            <div class="table-header-actions">
                <h3 class="compare-section-title">1. GENEL DOSYA ÖZETİ</h3>
                <div class="action-icons-group">
                    <div class="table-action-btn" onclick="copyTableToClipboard('comp-wrapper-gen')" title="Kopyala"><i class="fa-solid fa-copy"></i></div>
                    <div class="table-action-btn" onclick="saveTableExcel('comp-wrapper-gen', 'Genel_Dosya_Ozeti')" title="Kaydet"><i class="fa-solid fa-download"></i></div>
                    <div class="table-action-btn" onclick="toggleTableFullscreen('comp-wrapper-gen')" title="Tam Ekran"><i class="fa-solid fa-expand"></i></div>
                </div>
            </div>
            <div class="compare-table-scroll"><table class="compare-table-styled"><thead><tr><th>NO</th><th>Dosya Adı</th><th>Toplam Madde</th><th>Olağan/Ek</th><th>İlçe</th><th>Müdürlük</th></tr></thead><tbody>`;
        let totals = { t: 0, o: 0, e: 0, i: 0, m: 0 };
        allRes.forEach((f, idx) => {
            const st = { t: f.data.length, o: f.data.filter(x => x.gundemTuru === 'Olağan').length, e: f.data.filter(x => x.gundemTuru !== 'Olağan').length, i: new Set(f.data.map(x => x.ilce).filter(x => x)).size, m: new Set(f.data.map(x => x.mudurluk).filter(x => x)).size };
            totals.t += st.t; totals.o += st.o; totals.e += st.e; totals.i += st.i; totals.m += st.m;
            genHtml += `<tr><td class="text-center font-bold bg-slate-50">${idx+1}</td><td class="row-header">${formatDisplayFileName(f.name)}</td><td class="text-center font-bold text-blue-600">${st.t}</td><td class="text-center">${st.o}/${st.e}</td><td class="text-center">${st.i}</td><td class="text-center">${st.m}</td></tr>`;
        });
        genHtml += `<tr class="total-cell bg-slate-100 font-black"><td>Σ</td><td>GENEL TOPLAM</td><td>${totals.t}</td><td>${totals.o}/${totals.e}</td><td>${totals.i}</td><td>${totals.m}</td></tr></tbody></table></div></div>`;
        cont.insertAdjacentHTML('beforeend', genHtml);

        function createMatrix(title, key, color, wrapperId) {
            const map = {}, fNames = allRes.map(x => x.name);
            allRes.forEach(f => { f.data.forEach(i => { 
                const v = i[key] || "Belirtilmemiş"; 
                if (v === "Belirtilmemiş") return; 
                if(!map[v]) map[v] = {}; map[v][f.name] = (map[v][f.name] || 0) + 1; 
            })});
            
            let h = `<div class="table-container-wrapper" id="${wrapperId}">
                <div class="table-header-actions">
                    <h3 class="compare-section-title" style="border-color:${color}">${title}</h3>
                    <div class="action-icons-group">
                        <div class="table-action-btn" onclick="copyTableToClipboard('${wrapperId}')" title="Kopyala"><i class="fa-solid fa-copy"></i></div>
                        <div class="table-action-btn" onclick="saveTableExcel('${wrapperId}', '${title.replace(/'/g, "")}')" title="Kaydet"><i class="fa-solid fa-download"></i></div>
                        <div class="table-action-btn" onclick="toggleTableFullscreen('${wrapperId}')" title="Tam Ekran"><i class="fa-solid fa-expand"></i></div>
                    </div>
                </div>
                <div class="compare-table-scroll"><table class="compare-table-styled"><thead><tr><th>NO</th><th>Birim/Konu</th>`;
            fNames.forEach(n => h += `<th>${formatDisplayFileName(n)}</th>`);
            h += `<th class="bg-slate-200">TOPLAM</th></tr></thead><tbody>`;
            let colTotals = new Array(fNames.length).fill(0), grandTotal = 0;
            Object.keys(map).sort().forEach((k, rIdx) => {
                h += `<tr><td class="text-center font-bold bg-slate-50">${rIdx+1}</td><td class="row-header">${k}</td>`;
                let rowSum = 0; fNames.forEach((n, idx) => { const v = map[k][n] || 0; rowSum += v; colTotals[idx] += v; h += `<td class="text-center font-semibold">${v || '-'}</td>`; });
                grandTotal += rowSum; h += `<td class="total-cell font-black bg-slate-50">${rowSum}</td></tr>`;
            });
            h += `<tr class="total-cell bg-slate-100"><td>Σ</td><td>GENEL TOPLAM</td>`;
            colTotals.forEach(val => h += `<td>${val}</td>`);
            h += `<td class="bg-slate-200">${grandTotal}</td></tr></tbody></table></div></div>`;
            return h;
        }
        cont.insertAdjacentHTML('beforeend', createMatrix("2. İLÇE BAZLI KARŞILAŞTIRMA", "ilce", "#f97316", "comp-wrapper-ilce"));
        cont.insertAdjacentHTML('beforeend', createMatrix("3. MÜDÜRLÜK BAZLI KARŞILAŞTIRMA", "mudurluk", "#06b6d4", "comp-wrapper-mudurluk"));
        e.target.value = '';
    });

    function showSummary() {
        if (allItems.length === 0) return;
        document.getElementById('summary-modal').classList.remove('hidden');
        const byIlce = {}, byMudurluk = {}, byKategori = {};
        allItems.forEach(item => { 
            const il = item.ilce || "Belirtilmemiş"; byIlce[il] = (byIlce[il] || 0) + 1; 
            const mud = item.mudurluk || "Diğer"; byMudurluk[mud] = (byMudurluk[mud] || 0) + 1; 
            const kat = item.kategori || "Diğer"; byKategori[kat] = (byKategori[kat] || 0) + 1;
        });
        const sortObj = (obj) => Object.entries(obj).sort((a, b) => b[1] - a[1]);
        const content = document.getElementById('summary-content');
        const createTableHtml = (title, data, headerColor, rowColor) => {
            let total = data.reduce((sum, item) => sum + item[1], 0);
            return `<div class="mb-10"><h3 class="font-bold text-xl mb-4 border-l-4 pl-3" style="border-color:${headerColor}">${title}</h3><table class="summary-table shadow-sm"><thead><tr style="background-color:${headerColor}; color:white"><th>Başlık</th><th class="text-center w-32">Adet</th></tr></thead><tbody>${data.map(([k, v], i) => `<tr style="background-color:${i % 2 === 0 ? 'white' : rowColor}"><td>${k}</td><td class="text-center font-bold">${v}</td></tr>`).join('')}<tr class="total-row"><td>TOPLAM</td><td class="text-center">${total}</td></tr></tbody></table></div>`;
        };
        content.innerHTML = `<div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-12"><div class="stat-box shadow-sm border-blue-200"><div class="stat-value text-blue-600">${allItems.length}</div><div class="stat-label">Toplam Madde</div></div><div class="stat-box shadow-sm border-emerald-200"><div class="stat-value text-emerald-600">${Object.keys(byIlce).length}</div><div class="stat-label">Aktif İlçe</div></div><div class="stat-box shadow-sm border-amber-200"><div class="stat-value text-amber-600">${Object.keys(byKategori).length}</div><div class="stat-label">Kategori Sayısı</div></div></div><div class="grid grid-cols-1 lg:grid-cols-3 gap-8">${createTableHtml("İlçe Dağılımı", sortObj(byIlce), "#2563eb", "#eff6ff")}${createTableHtml("Müdürlük Dağılımı", sortObj(byMudurluk), "#059669", "#f0fdf4")}${createTableHtml("Kategori Dağılımı", sortObj(byKategori), "#d97706", "#fffbeb")}</div>`;
    }
    
    function exportToExcel() {
        if (allItems.length === 0) return;
        const data = allItems.map(x => ({ "NO": x.siraNo, "Gündem No": x.gundemSayiNo, "Tür": x.gundemTuru, "İlçe": x.ilce, "Kategori": x.kategori, "Gündem Maddesi": x.maddeMetni, "Teklif Veren": x.mudurluk }));
        const ws = XLSX.utils.json_to_sheet(data), wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "Gündem"); XLSX.writeFile(wb, `Meclis_Gundemi.xlsx`);
    }

    function loadProject(input) {
        const file = input.files[0]; if (!file) return;
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const project = JSON.parse(e.target.result);
                if (project.data) { allItems = project.data; renderTable(allItems); populateCheckboxes(); closeLanding(); }
            } catch (err) { alert("Geçersiz dosya."); }
        };
        reader.readAsText(file); input.value = '';
    }
</script>
</body>
</html>
<script>

</script>
</body></html>