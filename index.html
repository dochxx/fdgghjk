<!doctype html><html><head><meta charset="utf-8"/><title>Bundled App</title><meta name="viewport" content="width=device-width,initial-scale=1"/><style>

</style></head><body>
<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meclis Gündem Ayrıştırıcı</title>
    <!-- PDF.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    </script>
    <!-- SheetJS (Excel) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #f8fafc;
            padding-bottom: 60px;
        }
        
        .sticky-wrapper {
            position: sticky;
            top: 0;
            z-index: 50;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        /* ÜST BANNER */
        .top-banner {
            background-color: #0f172a; 
            color: #e2e8f0;
            padding: 10px 24px;
            border-bottom: 1px solid #334155;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }

        .top-banner-title {
            font-size: 1.1rem;
            font-weight: 700;
            letter-spacing: 0.05em;
            color: white;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* Global Arama Kutusu */
        .global-search {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 0.85rem;
            width: 250px;
            transition: all 0.3s;
        }
        .global-search:focus {
            outline: none;
            background: rgba(255, 255, 255, 0.2);
            border-color: rgba(255, 255, 255, 0.5);
        }
        .global-search::placeholder { color: #94a3b8; }

        .table-header {
            background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
            border-bottom: 2px solid #475569;
            overflow-x: auto;
        }
        
        .table-header table { width: 100%; table-layout: fixed; }

        .table-header th {
            padding: 14px 8px;
            font-size: 0.75rem;
            font-weight: 700;
            text-transform: uppercase;
            color: #f1f5f9;
            text-align: left;
            border-right: 1px solid #475569;
            letter-spacing: 0.05em;
        }
        .table-header th:last-child { border-right: none; }

        .filter-header {
            background-color: #f8fafc;
            border-bottom: 1px solid #cbd5e1;
            padding: 8px 0;
            display: none; 
        }
        .filter-header.active { display: block; animation: slideDown 0.2s ease-out; }
        @keyframes slideDown { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }

        .filter-header table { width: 100%; table-layout: fixed; }
        .filter-header td { padding: 0 8px; }

        .data-table {
            width: 100%;
            table-layout: fixed;
            border-collapse: collapse;
            background-color: white;
        }

        .data-table td {
            padding: 12px 8px;
            font-size: 0.875rem;
            color: #334155;
            border-bottom: 1px solid #e2e8f0;
            border-right: 1px solid #e2e8f0;
            vertical-align: top;
            word-wrap: break-word;
        }
        
        .data-table tr.highlighted td { background-color: #fff7ed !important; color: #ea580c; }
        .data-table tr:hover td { background-color: #f0f9ff; }

        /* Kategori Badge Stilleri */
        .badge { display: inline-block; padding: 2px 8px; border-radius: 4px; font-size: 0.75rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.02em; }
        .badge-imar { background-color: #dbeafe; color: #1e40af; border: 1px solid #bfdbfe; }
        .badge-odenek { background-color: #dcfce7; color: #166534; border: 1px solid #bbf7d0; }
        .badge-tarife { background-color: #ffedd5; color: #9a3412; border: 1px solid #fed7aa; }
        .badge-isim { background-color: #f3e8ff; color: #6b21a8; border: 1px solid #e9d5ff; }
        .badge-diger { background-color: #f1f5f9; color: #475569; border: 1px solid #e2e8f0; }

        /* HARİTA İKONLARI (GÜNCELLENDİ: HEPSİ YEŞİL VE DÜZ ÇİZGİ) */
        .map-actions {
            display: flex;
            gap: 8px;
            margin-top: 8px;
        }
        .action-btn {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 5px 10px;
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 700;
            text-decoration: none;
            transition: all 0.2s;
            border-width: 1px;
            border-style: solid !important; /* KESİNLİKLE DÜZ ÇİZGİ */
        }
        
        /* Google Maps Butonu: Yeşil */
        .btn-maps { 
            background-color: #ecfdf5; /* Çok açık yeşil */
            color: #047857; /* Koyu yeşil metin */
            border-color: #10b981; /* Canlı yeşil kenarlık */
        }
        .btn-maps:hover { 
            background-color: #d1fae5; 
            border-color: #059669;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        /* TKGM Butonu: Turkuaz/Yeşil (Turuncudan Yeşile Döndü) */
        .btn-tkgm { 
            background-color: #f0fdf4; 
            color: #15803d; 
            border-color: #22c55e; /* Düz yeşil çizgi */
        }
        .btn-tkgm:hover { 
            background-color: #bbf7d0; 
            border-color: #16a34a;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        /* PDF Linki */
        .pdf-link {
            color: #334155;
            text-decoration: none;
            display: block;
            cursor: pointer;
        }
        .pdf-link:hover {
            color: #2563eb;
            text-decoration: underline;
        }

        /* FOOTER */
        .bottom-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background-color: #ffffff;
            border-top: 1px solid #cbd5e1;
            padding: 12px 24px;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 60;
            box-shadow: 0 -4px 6px -1px rgba(0, 0, 0, 0.05);
            font-size: 0.9rem;
            font-weight: 600;
            color: #334155;
        }

        .col-sira { width: 5%; text-align: center; }
        .col-no { width: 10%; text-align: center; }
        .col-tur { width: 9%; text-align: center; }
        .col-ilce { width: 10%; }
        .col-kat { width: 12%; }
        .col-madde { width: 29%; }
        .col-mud { width: 13%; }
        .col-acik { width: 12%; }

        .filter-input { width: 100%; font-size: 0.75rem; padding: 6px; border: 1px solid #cbd5e1; border-radius: 4px; transition: border-color 0.2s; }
        .filter-input:focus { border-color: #3b82f6; outline: none; }

        .dropdown-content { display: none; position: absolute; background-color: white; min-width: 200px; max-height: 300px; overflow-y: auto; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.2); z-index: 100; border: 1px solid #cbd5e1; border-radius: 6px; padding: 8px; top: 100%; margin-top: 4px; }
        .dropdown-content.show { display: block; }

        .checkbox-label { display: flex; align-items: center; padding: 6px; cursor: pointer; font-size: 0.8rem; color: #475569; }
        .checkbox-label:hover { background-color: #f1f5f9; }
        .checkbox-label input { margin-right: 8px; }

        /* MODAL STİLLERİ - TAM EKRAN */
        #summary-modal {
            transition: opacity 0.2s ease-in-out;
            background-color: white; 
        }
        #summary-modal.hidden { opacity: 0; pointer-events: none; }
        #summary-modal:not(.hidden) { opacity: 1; pointer-events: auto; }
        
        /* Özet Tablo Stilleri */
        .summary-table { width: 100%; border-collapse: collapse; margin-bottom: 20px; font-size: 0.9rem; }
        .summary-table th { background-color: #f1f5f9; color: #1e293b; font-weight: 700; padding: 10px; text-align: left; border: 1px solid #cbd5e1; }
        .summary-table td { padding: 8px 10px; border: 1px solid #cbd5e1; color: #334155; }
        .summary-table tr:nth-child(even) { background-color: #f8fafc; }
        
        .stat-box {
            background-color: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
        }
        .stat-value { font-size: 2rem; font-weight: 800; color: #0f172a; }
        .stat-label { font-size: 0.85rem; color: #64748b; font-weight: 600; text-transform: uppercase; }
    </style>
</head>
<body>

    <!-- TAM EKRAN ÖZET MODALI -->
    <div id="summary-modal" class="fixed inset-0 z-[100] hidden flex flex-col">
        <!-- Header -->
        <div class="bg-slate-900 text-white p-4 flex justify-between items-center shadow-md">
            <div class="flex items-center gap-3">
                <svg class="w-6 h-6 text-amber-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                <h1 class="text-xl font-bold tracking-wide">ÖZET MECLİS GÜNDEM ÖZET TABLOSU</h1>
            </div>
            <div class="flex gap-4">
                <button onclick="copySummary()" class="flex items-center gap-2 px-4 py-2 bg-blue-600 hover:bg-blue-500 rounded text-sm font-medium transition">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3"></path></svg>
                    Panoya Kopyala
                </button>
                <button onclick="closeSummary()" class="flex items-center gap-2 px-4 py-2 bg-slate-700 hover:bg-slate-600 rounded text-sm font-medium transition">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                    Kapat
                </button>
            </div>
        </div>

        <!-- Scrollable Content -->
        <div class="flex-1 overflow-y-auto p-8 bg-white">
            <div id="summary-content" class="max-w-7xl mx-auto space-y-8">
                <!-- İçerik JS ile doldurulacak -->
            </div>
        </div>
    </div>

    <!-- ANA SAYFA YAPISI -->
    <div class="sticky-wrapper">
        <div class="top-banner">
            <div class="flex items-center gap-6">
                <div class="top-banner-title">
                    <svg class="w-6 h-6 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/></svg>
                    İBB MECLİS GÜNDEM ARACI
                </div>
                <div class="relative">
                    <input type="text" id="globalSearch" onkeyup="globalSearchTable()" placeholder="Hızlı Arama..." class="global-search">
                    <svg class="w-4 h-4 text-slate-400 absolute right-3 top-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                </div>
            </div>
            
            <div class="flex gap-3 ml-auto">
                <button onclick="showSummary()" class="px-3 py-1.5 bg-amber-600 hover:bg-amber-500 border border-amber-500 rounded text-xs font-medium text-white transition flex items-center gap-2 shadow-sm">
                    <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                    Özet
                </button>
                <button onclick="toggleFilters()" id="filter-btn" class="px-3 py-1.5 bg-slate-700 hover:bg-slate-600 border border-slate-500 rounded text-xs font-medium text-white transition flex items-center gap-2">
                    <svg class="w-3.5 h-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z"/></svg>
                    Filtrele
                </button>
                <button onclick="exportToExcel()" class="px-3 py-1.5 bg-emerald-700 hover:bg-emerald-600 border border-emerald-500 rounded text-xs font-medium text-white transition flex items-center gap-2">
                    <svg class="w-3.5 h-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/></svg>
                    Excel
                </button>
                <label class="px-3 py-1.5 bg-blue-700 hover:bg-blue-600 border border-blue-500 rounded text-xs font-medium text-white transition cursor-pointer flex items-center gap-2">
                    <input type="file" id="pdf-upload" accept=".pdf" class="hidden" />
                    <svg class="w-3.5 h-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"/></svg>
                    PDF Yükle
                </label>
            </div>
        </div>

        <div class="table-header">
            <table>
                <thead>
                    <tr>
                        <th class="col-sira">Sıra</th>
                        <th class="col-no">Gündem No</th>
                        <th class="col-tur">Tür</th>
                        <th class="col-ilce">İlçe</th>
                        <th class="col-kat">Kategori</th>
                        <th class="col-madde">Gündem Maddesi</th>
                        <th class="col-mud">Teklif Veren</th>
                        <th class="col-acik">Açıklama</th>
                    </tr>
                </thead>
            </table>
        </div>

        <div id="filter-row" class="filter-header">
            <table>
                <tr>
                    <td class="col-sira"><input type="text" onkeyup="filterTableText(0)" class="filter-input" placeholder="#"></td>
                    <td class="col-no"><input type="text" onkeyup="filterTableText(1)" class="filter-input" placeholder="Dosya No"></td>
                    <td class="col-tur relative"><button id="btn-tur" onclick="toggleDropdown('dd-tur')" class="filter-input text-left flex justify-between bg-white text-slate-600"><span>Tümü</span> ▾</button><div id="dd-tur" class="dropdown-content"></div></td>
                    <td class="col-ilce relative"><button id="btn-ilce" onclick="toggleDropdown('dd-ilce')" class="filter-input text-left flex justify-between bg-white text-slate-600"><span>Tümü</span> ▾</button><div id="dd-ilce" class="dropdown-content"></div></td>
                    <td class="col-kat"><input type="text" onkeyup="filterTableText(4)" class="filter-input" placeholder="Kategori"></td>
                    <td class="col-madde"><input type="text" onkeyup="filterTableText(5)" class="filter-input" placeholder="Madde içeriği..."></td>
                    <td class="col-mud relative"><button id="btn-mudurluk" onclick="toggleDropdown('dd-mudurluk')" class="filter-input text-left flex justify-between bg-white text-slate-600"><span>Tümü</span> ▾</button><div id="dd-mudurluk" class="dropdown-content"></div></td>
                    <td class="col-acik"><input type="text" onkeyup="filterTableText(7)" class="filter-input" placeholder="Açıklama..."></td>
                </tr>
            </table>
        </div>
    </div>

    <div class="data-container">
        <table id="main-table" class="data-table">
            <tbody id="result-body">
                <tr>
                    <td colspan="8" class="p-24 text-center text-slate-400 flex flex-col items-center justify-center">
                        <svg class="w-16 h-16 mb-4 opacity-20" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                        <span>Veri bekleniyor... Lütfen PDF dosyasını yükleyin.</span>
                    </td>
                </tr>
            </tbody>
        </table>
    </div>

    <div class="bottom-bar">
        Saadet Partisi İstanbul İlçe Başkanlığı İbb Meclis Gündem Aracı
    </div>

<script>
    const ILCELER = ["Adalar", "Arnavutköy", "Ataşehir", "Avcılar", "Bağcılar", "Bahçelievler", "Bakırköy", "Başakşehir", "Bayrampaşa", "Beşiktaş", "Beykoz", "Beylikdüzü", "Beyoğlu", "Büyükçekmece", "Çatalca", "Çekmeköy", "Esenler", "Esenyurt", "Eyüpsultan", "Eyüp", "Fatih", "Gaziosmanpaşa", "Güngören", "Kadıköy", "Kağıthane", "Kartal", "Küçükçekmece", "Maltepe", "Pendik", "Sancaktepe", "Sarıyer", "Silivri", "Sultanbeyli", "Sultangazi", "Şile", "Şişli", "Tuzla", "Ümraniye", "Üsküdar", "Zeytinburnu"];
    
    let allItems = [];
    let activeFilters = { 0: "", 1: "", 2: [], 3: [], 4: "", 5: "", 6: [], 7: "" };
    let globalPdfUrl = null;

    function toTitleCase(str) {
        if (!str) return "";
        return str.toLocaleLowerCase('tr').split(" ").map(word => word.charAt(0).toLocaleUpperCase('tr') + word.slice(1)).join(" ");
    }

    function fixBrokenWords(text) {
        if (!text) return "";
        let fixed = text.replace(/\b(?:[a-zA-ZğüşıöçĞÜŞİÖÇİ]\s+){2,}[a-zA-ZğüşıöçĞÜŞİÖÇİ]\b/g, function(match) { return match.replace(/\s+/g, ''); });
        return fixed.replace(/\s+/g, ' ').trim();
    }

    function showSummary() {
        if (allItems.length === 0) return alert("Önce bir PDF yüklemelisiniz.");
        document.getElementById('summary-modal').classList.remove('hidden');
        
        const total = allItems.length;
        const byIlce = {};
        const byMudurluk = {};
        const byKategori = {};

        allItems.forEach(item => {
            const ilce = item.ilce || "Belirtilmemiş";
            if (ilce !== "Belirtilmemiş") byIlce[ilce] = (byIlce[ilce] || 0) + 1;
            const mud = item.mudurluk || "Diğer"; byMudurluk[mud] = (byMudurluk[mud] || 0) + 1;
            const kat = item.kategori || "Genel"; byKategori[kat] = (byKategori[kat] || 0) + 1;
        });

        const sortObj = (obj) => Object.entries(obj).sort((a, b) => b[1] - a[1]);
        const sortedIlce = sortObj(byIlce);
        const sortedMudurluk = sortObj(byMudurluk);
        const sortedKategori = sortObj(byKategori);

        const content = document.getElementById('summary-content');
        
        let html = `
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
                <div class="stat-box">
                    <div class="stat-value text-blue-600">${total}</div>
                    <div class="stat-label">Toplam Gündem Maddesi</div>
                </div>
                <div class="stat-box">
                    <div class="stat-value text-purple-600">${sortedIlce.length}</div>
                    <div class="stat-label">Teklif Veren İlçe Sayısı</div>
                </div>
                <div class="stat-box">
                    <div class="stat-value text-amber-600">${sortedMudurluk.length}</div>
                    <div class="stat-label">Teklif Veren Müdürlük Sayısı</div>
                </div>
                <div class="stat-box">
                    <div class="stat-value text-emerald-600">${sortedKategori.length}</div>
                    <div class="stat-label">Farklı Kategori Sayısı</div>
                </div>
            </div>
        `;

        html += `<div class="grid grid-cols-1 md:grid-cols-3 gap-8">`;

        // İLÇE TABLOSU
        html += `<div>
            <h3 class="font-bold text-lg text-slate-800 mb-3 border-b pb-2">İlçe Bazlı Dağılım</h3>
            <table class="summary-table">
                <thead><tr><th>Teklif Veren İlçe</th><th class="w-24 text-center">Teklif Sayısı</th></tr></thead>
                <tbody>
                    ${sortedIlce.map(([key, val]) => `<tr><td>${key}</td><td class="text-center font-bold">${val}</td></tr>`).join('')}
                </tbody>
            </table>
        </div>`;

        // MÜDÜRLÜK TABLOSU
        html += `<div>
            <h3 class="font-bold text-lg text-slate-800 mb-3 border-b pb-2">Müdürlük Bazlı Dağılım</h3>
            <table class="summary-table">
                <thead><tr><th>Teklif Veren Müdürlük</th><th class="w-24 text-center">Teklif Sayısı</th></tr></thead>
                <tbody>
                    ${sortedMudurluk.map(([key, val]) => `<tr><td>${key}</td><td class="text-center font-bold">${val}</td></tr>`).join('')}
                </tbody>
            </table>
        </div>`;

        // KATEGORİ TABLOSU
        html += `<div>
            <h3 class="font-bold text-lg text-slate-800 mb-3 border-b pb-2">Konu Kategorileri</h3>
            <table class="summary-table">
                <thead><tr><th>Kategori Adı</th><th class="w-24 text-center">Adet</th></tr></thead>
                <tbody>
                    ${sortedKategori.map(([key, val]) => `<tr><td>${key}</td><td class="text-center font-bold">${val}</td></tr>`).join('')}
                </tbody>
            </table>
        </div>`;

        html += `</div>`; 
        content.innerHTML = html;
    }

    function closeSummary() { document.getElementById('summary-modal').classList.add('hidden'); }

    function copySummary() {
        if (allItems.length === 0) return alert("Veri yok.");
        const total = allItems.length;
        const byIlce = {}, byMudurluk = {}, byKategori = {};
        allItems.forEach(item => {
            if (item.ilce) byIlce[item.ilce] = (byIlce[item.ilce] || 0) + 1;
            if (item.mudurluk) byMudurluk[item.mudurluk] = (byMudurluk[item.mudurluk] || 0) + 1;
            const kat = item.kategori || "Genel"; byKategori[kat] = (byKategori[kat] || 0) + 1;
        });
        const sortObj = (obj) => Object.entries(obj).sort((a, b) => b[1] - a[1]);

        let text = `ÖZET MECLİS GÜNDEM ÖZET TABLOSU\n\n`;
        text += `TOPLAM GÜNDEM MADDESİ SAYISI: ${total}\n`;
        text += `\nTEKLİF VEREN İLÇE SAYISI: ${Object.keys(byIlce).length}\n`;
        text += `TEKLİF VEREN MÜDÜRLÜK SAYISI: ${Object.keys(byMudurluk).length}\n`;
        text += `KATEGORİ SAYISI: ${Object.keys(byKategori).length}\n`;
        text += `-----------------------------------\n\n`;

        text += `İLÇE ADI\tTEKLİF SAYISI\n`;
        sortObj(byIlce).forEach(([k, v]) => text += `${k}\t${v}\n`);
        text += `\n`;

        text += `MÜDÜRLÜK ADI\tTEKLİF SAYISI\n`;
        sortObj(byMudurluk).forEach(([k, v]) => text += `${k}\t${v}\n`);
        text += `\n`;

        text += `KATEGORİ\tADET\n`;
        sortObj(byKategori).forEach(([k, v]) => text += `${k}\t${v}\n`);

        const textArea = document.createElement("textarea");
        textArea.value = text;
        document.body.appendChild(textArea);
        textArea.select();
        document.execCommand("Copy");
        textArea.remove();
        
        alert("Özet tablosu kopyalandı!");
    }

    document.getElementById('pdf-upload').addEventListener('change', async function(e) {
        const file = e.target.files[0];
        if (!file) return;
        globalPdfUrl = URL.createObjectURL(file);

        try {
            const arrayBuffer = await file.arrayBuffer();
            const pdf = await pdfjsLib.getDocument(arrayBuffer).promise;
            let fullLines = [];
            
            for (let i = 1; i <= pdf.numPages; i++) {
                const page = await pdf.getPage(i);
                const textContent = await page.getTextContent();
                const sortedItems = textContent.items.sort((a, b) => {
                    const yA = a.transform[5], yB = b.transform[5];
                    if (Math.abs(yA - yB) < 8) return a.transform[4] - b.transform[4];
                    return yB - yA;
                });

                let currentLineY = -1, currentLineText = "";
                for (const item of sortedItems) {
                    const y = item.transform[5], text = item.str;
                    if (currentLineY === -1) { currentLineY = y; currentLineText = text; }
                    else if (Math.abs(y - currentLineY) > 8) { fullLines.push(currentLineText); currentLineText = text; currentLineY = y; }
                    else { currentLineText += " " + text; }
                }
                if (currentLineText) fullLines.push(currentLineText);
            }

            allItems = parseLinesToItems(fullLines);
            let olagan = allItems.filter(i => i.gundemTuru === 'Olağan').sort((a,b) => parseInt(a.siraNo) - parseInt(b.siraNo));
            let ek = allItems.filter(i => i.gundemTuru === 'Ek Gündem').sort((a,b) => parseInt(a.siraNo) - parseInt(b.siraNo));
            allItems = [...olagan, ...ek];

            renderTable(allItems);
            populateCheckboxes();
        } catch (error) { console.error(error); alert("Hata: " + error.message); }
    });

    function parseLinesToItems(lines) {
        let items = [], currentMode = "Olağan", currentItem = null, startParsing = false;
        for (let i = 0; i < lines.length; i++) {
            let line = lines[i].trim();
            if (!line || /^(Sayfa\s*)?[\d\s\/]+$/i.test(line) || /^---\s*PAGE\s*\d+\s*---$/i.test(line)) continue;
            const upperLine = line.toLocaleUpperCase('tr');

            if (!startParsing) {
                if (upperLine.includes("TEKLİFLER") && !upperLine.includes("EK")) { startParsing = true; continue; }
                const match = line.match(/^(\d{1,3})\.\s+(.*)/);
                if (match && !/^\d{1,2}\.\d{1,2}\.\d{4}$/.test(match[2].trim())) startParsing = true;
                if (!startParsing) continue;
            }

            if (upperLine.includes("BAŞKANLIK EK TEKLİFLERİ")) { currentMode = "Ek Gündem"; continue; }

            const match = line.match(/^(\d{1,3})\.\s+(.*)/);
            if (match) {
                if (/^\d{1,2}\.\d{1,2}\.\d{4}$/.test(match[2].trim())) continue;
                if (currentItem) items.push(analyzeItem(currentItem.siraNo, currentItem.text, currentItem.mode));
                currentItem = { siraNo: match[1], text: match[2], mode: currentMode };
            } else {
                if (currentItem) {
                    line = line.replace(/\s*Sayfa\s*\d+(\s+\d+)?\s*$/i, '');
                    currentItem.text += " " + line;
                }
            }
        }
        if (currentItem) items.push(analyzeItem(currentItem.siraNo, currentItem.text, currentItem.mode));
        return items;
    }

    function analyzeItem(siraNo, text, gundemTuru) {
        let cleanText = fixBrokenWords(text);
        cleanText = cleanText.replace(/\bSayfa\s+[\d\s\/]+\b/gi, '')
                             .replace(/([a-zA-ZğüşıöçĞÜŞİÖÇ])-\s+([a-zA-ZğüşıöçĞÜŞİÖÇ])/g, '$1$2')
                             .replace(/\s+([.,;:)])/g, '$1')
                             .replace(/([a-zA-ZğüşıöçĞÜŞİÖÇ])\(/g, '$1 (')
                             .replace(/\s+/g, ' ').trim();

        let kategori = "";
        const lowerText = cleanText.toLocaleLowerCase('tr');
        if (lowerText.includes('ödenek')) kategori = "Ödenek İşlemleri";
        else if (lowerText.includes('ücret') || lowerText.includes('tarife')) kategori = "Ücret Tarife İşlemleri";
        else if (lowerText.includes('isim')) kategori = "İsimlendirme";

        const parantezRegex = /\(([^)]+)\)/g;
        let match;
        let gundemSayiNo = "";
        while ((match = parantezRegex.exec(cleanText)) !== null) { if (/\d/.test(match[1])) gundemSayiNo = match[1]; }

        let bulunanIlce = "", mudurluk = "";
        for (const ilce of ILCELER) { if (cleanText.toLocaleLowerCase('tr').includes(ilce.toLocaleLowerCase('tr'))) { bulunanIlce = ilce; break; } }
        
        let mahalle = "";
        const mahalleMatch = cleanText.match(/([A-ZÇĞİÖŞÜa-zçğıöşü]+\s+)+Mahallesi/);
        if(mahalleMatch) {
             mahalle = mahalleMatch[0].replace('Mahallesi', '').trim();
        }

        const belediyeMatch = cleanText.match(/([a-zA-ZğüşıöçĞÜŞİÖÇ\s]+Belediye Başkanlığı)\s+teklifi/i);
        if (belediyeMatch) {
            mudurluk = "";
            if (!bulunanIlce) {
                const bName = belediyeMatch[1].toLocaleLowerCase('tr');
                for (const ilce of ILCELER) { if (bName.includes(ilce.toLocaleLowerCase('tr'))) { bulunanIlce = ilce; break; } }
            }
        } else {
            const mudMatch = cleanText.match(/([^,.]*?(?:Müdürlüğü|Dairesi Başkanlığı|Genel Müdürlüğü))\s+teklifi/i);
            if (mudMatch) mudurluk = mudMatch[1].trim();
        }

        let hasParsel = false;
        let mapLink = "";
        
        if (/(\d+)\s*ada/.test(cleanText.toLowerCase())) {
            hasParsel = true;
            if (mahalle && bulunanIlce) {
                mapLink = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(mahalle + " Mahallesi, " + bulunanIlce + ", İstanbul")}`;
            } else if (bulunanIlce) {
                mapLink = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(bulunanIlce + ", İstanbul")}`;
            } else {
                mapLink = `https://www.google.com/maps/search/?api=1&query=İstanbul`;
            }
        }

        return { 
            siraNo, gundemSayiNo, gundemTuru, 
            ilce: toTitleCase(bulunanIlce), 
            kategori: toTitleCase(kategori), 
            maddeMetni: cleanText, 
            mudurluk: toTitleCase(mudurluk),
            hasParsel: hasParsel,
            mapLink: mapLink
        };
    }

    function toggleFilters() { document.getElementById('filter-row').classList.toggle('active'); }
    function toggleDropdown(id) { document.querySelectorAll('.dropdown-content').forEach(d => { if(d.id !== id) d.classList.remove('show'); }); document.getElementById(id).classList.toggle("show"); }
    window.onclick = function(e) { if (!e.target.closest('button')) document.querySelectorAll('.dropdown-content').forEach(d => d.classList.remove('show')); }

    function renderTable(items) {
        const tbody = document.getElementById('result-body');
        if (items.length === 0) { tbody.innerHTML = '<tr><td colspan="8" class="p-16 text-center text-slate-400">Veri bulunamadı.</td></tr>'; return; }
        
        tbody.innerHTML = items.map((item, i) => `
            <tr onclick="toggleHighlight(this)" class="${i % 2 === 0 ? 'bg-white' : 'bg-slate-50'} border-b border-slate-100 hover:bg-indigo-50/30 transition-colors">
                <td class="col-sira font-bold text-slate-700 text-center">${item.siraNo}</td>
                <td class="col-no text-xs font-mono text-blue-600 bg-blue-50/50 text-center rounded px-1 mx-2 block w-fit mx-auto mt-2 border border-blue-100">${item.gundemSayiNo}</td>
                <td class="col-tur text-[10px] font-bold text-center uppercase tracking-wide ${item.gundemTuru === 'Ek Gündem' ? 'text-rose-600 bg-rose-50' : 'text-emerald-700 bg-emerald-50'} py-1 rounded mx-2">${item.gundemTuru}</td>
                <td class="col-ilce text-sm text-slate-800 font-semibold">${item.ilce}</td>
                <td class="col-kat text-xs font-bold text-center" contenteditable="true">
                    <span class="badge ${item.kategori === 'İmar' ? 'badge-imar' : item.kategori.includes('Ödenek') ? 'badge-odenek' : item.kategori.includes('Ücret') ? 'badge-tarife' : item.kategori === 'İsimlendirme' ? 'badge-isim' : 'badge-diger'}">
                        ${item.kategori || 'Diğer'}
                    </span>
                </td>
                <td class="col-madde text-sm text-slate-700 leading-snug">
                    <a href="${globalPdfUrl ? globalPdfUrl : '#'}" target="_blank" class="pdf-link" title="Orijinal PDF'i Görüntüle">${item.maddeMetni}</a>
                    ${item.hasParsel ? `
                        <div class="map-actions">
                            <a href="${item.mapLink}" target="_blank" class="action-btn btn-maps">
                                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                                Haritada Gör
                            </a>
                            <a href="https://parselsorgu.tkgm.gov.tr/" target="_blank" class="action-btn btn-tkgm">
                                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3.055 11H5a2 2 0 012 2v1a2 2 0 002 2 2 2 0 012 2v2.945M8 3.935V5.5A2.5 2.5 0 0010.5 8h.5a2 2 0 012 2 2 2 0 104 0 2 2 0 012-2h1.064M15 20.488V18a2 2 0 012-2h3.064M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                                TKGM Parsel
                            </a>
                        </div>
                    ` : ''}
                </td>
                <td class="col-mud text-xs font-semibold text-slate-600 uppercase tracking-tight">${item.mudurluk}</td>
                <td class="col-acik text-sm text-slate-500" contenteditable="true"></td>
            </tr>
        `).join('');
    }

    function toggleHighlight(row) { row.classList.toggle('highlighted'); }

    function globalSearchTable() {
        const query = document.getElementById('globalSearch').value.toLocaleUpperCase('tr');
        const rows = document.getElementById('result-body').getElementsByTagName('tr');
        for (let row of rows) {
            row.style.display = row.innerText.toLocaleUpperCase('tr').includes(query) ? '' : 'none';
        }
    }

    function filterTableText(colIndex) {
        const val = document.getElementById('filter-row').children[0].children[0].children[0].children[colIndex].querySelector('input').value.toLocaleUpperCase('tr');
        activeFilters[colIndex] = val;
        applyAllFilters();
    }

    function applyAllFilters() {
        const rows = document.getElementById('result-body').getElementsByTagName('tr');
        for (let row of rows) {
            let show = true;
            const cells = row.getElementsByTagName('td');
            if (cells.length < 8) continue;
            for (let [col, filter] of Object.entries(activeFilters)) {
                const txt = cells[col].innerText.trim();
                if (Array.isArray(filter)) { if (filter.length > 0 && !filter.includes(txt)) show = false; } 
                else { if (filter && !txt.toLocaleUpperCase('tr').includes(filter)) show = false; }
            }
            row.style.display = show ? '' : 'none';
        }
    }

    function populateCheckboxes() { createCheckboxList(allItems, 'gundemTuru', 'dd-tur', 'btn-tur', 2); createCheckboxList(allItems, 'ilce', 'dd-ilce', 'btn-ilce', 3); createCheckboxList(allItems, 'mudurluk', 'dd-mudurluk', 'btn-mudurluk', 6); }
    function createCheckboxList(items, key, containerId, btnId, colIndex) {
        const unique = [...new Set(items.map(i => i[key]).filter(x => x))].sort((a, b) => a.localeCompare(b, 'tr'));
        const container = document.getElementById(containerId); container.innerHTML = '';
        const clearBtn = document.createElement('div'); clearBtn.className = 'checkbox-label font-bold border-b text-red-500 mb-2 hover:bg-red-50 transition-colors'; clearBtn.innerText = 'Temizle';
        clearBtn.onclick = () => { container.querySelectorAll('input').forEach(i => i.checked = false); updateFilter(colIndex, containerId, btnId); }; container.appendChild(clearBtn);
        unique.forEach(val => {
            const lbl = document.createElement('label'); lbl.className = 'checkbox-label';
            const chk = document.createElement('input'); chk.type = 'checkbox'; chk.value = val;
            chk.onchange = () => updateFilter(colIndex, containerId, btnId);
            lbl.appendChild(chk); lbl.appendChild(document.createTextNode(val)); container.appendChild(lbl);
        });
    }
    function updateFilter(col, con, btnId) {
        const checked = Array.from(document.getElementById(con).querySelectorAll('input:checked')).map(c => c.value);
        activeFilters[col] = checked;
        const btn = document.getElementById(btnId).querySelector('span');
        if (checked.length === 0) { btn.textContent = 'Tümü'; btn.classList.remove('text-indigo-600', 'font-bold'); } 
        else { btn.textContent = `${checked.length} Seçili`; btn.classList.add('text-indigo-600', 'font-bold'); }
        applyAllFilters();
    }

    function exportToExcel() {
        const tbl = document.getElementById("main-table");
        if (tbl.rows.length < 2) return alert("Veri yok");
        const wb = XLSX.utils.table_to_book(tbl, {sheet: "Gundem"});
        XLSX.writeFile(wb, "Meclis_Gundem_Listesi.xlsx");
    }
</script>
</body>
</html>
<script>

</script>
</body></html>